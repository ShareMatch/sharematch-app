# =============================================================================
# Agentic Testing Pipeline
# =============================================================================
# This workflow runs Playwright tests on Pull Requests.
# It uses the Sumsub adapter to verify both UI and backend state.
#
# Triggers:
#   - On PR to staging or main
#   - Manual trigger (workflow_dispatch)
#
# What it does:
#   1. Spins up the dev server
#   2. Runs Playwright tests
#   3. Generates audit reports
#   4. Uploads artifacts (screenshots, videos, reports)
# =============================================================================

name: Agentic Tests

on:
  pull_request:
    branches:
      - staging
      - main
  workflow_dispatch:  # Allow manual trigger

jobs:
  test:
    name: Run Playwright Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Prevent runaway tests

    env:
      # Sumsub Sandbox credentials (from GitHub Secrets)
      SUMSUB_APP_TOKEN: ${{ secrets.SUMSUB_APP_TOKEN }}
      SUMSUB_SECRET_KEY: ${{ secrets.SUMSUB_SECRET_KEY }}
      SUMSUB_BASE_URL: https://api.sumsub.com
      
      # App configuration
      APP_BASE_URL: http://localhost:3000
      
      # Supabase (for the app to work)
      VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
      VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}

    steps:
      # -----------------------------------------------------------------------
      # Step 1: Checkout the code
      # -----------------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Step 2: Setup Node.js
      # -----------------------------------------------------------------------
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # -----------------------------------------------------------------------
      # Step 3: Install dependencies
      # -----------------------------------------------------------------------
      - name: Install dependencies
        run: npm ci

      # -----------------------------------------------------------------------
      # Step 4: Install Playwright browsers
      # This downloads Chromium, Firefox, WebKit
      # -----------------------------------------------------------------------
      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      # -----------------------------------------------------------------------
      # Step 5: Build the app (for production-like testing)
      # -----------------------------------------------------------------------
      - name: Build application
        run: npm run build

      # -----------------------------------------------------------------------
      # Step 6: Run Playwright tests
      # - Starts the dev server automatically (via playwright.config.ts)
      # - Runs all tests in tests/ folder
      # - Generates reports
      # -----------------------------------------------------------------------
      - name: Run Playwright tests
        run: npx playwright test
        continue-on-error: true  # Don't fail immediately, we want artifacts

      # -----------------------------------------------------------------------
      # Step 7: Upload test results as artifacts
      # This preserves:
      #   - HTML reports (visual audit trail)
      #   - JSON results (machine-readable)
      #   - Screenshots (proof of failures)
      #   - Videos (replay capability)
      # -----------------------------------------------------------------------
      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests fail
        with:
          name: audit-reports
          path: |
            audit-reports/
            test-results/
            playwright-report/
          retention-days: 30

      # -----------------------------------------------------------------------
      # Step 8: Post test summary to PR
      # -----------------------------------------------------------------------
      - name: Post test summary
        if: always()
        run: |
          echo "## ðŸŽ­ Agentic Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f "audit-reports/results.json" ]; then
            echo "### Test Results" >> $GITHUB_STEP_SUMMARY
            cat audit-reports/results.json | jq -r '.suites[] | "- \(.title): \(.specs | length) tests"' >> $GITHUB_STEP_SUMMARY || true
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“‹ Download the full audit report from the Artifacts section above." >> $GITHUB_STEP_SUMMARY

